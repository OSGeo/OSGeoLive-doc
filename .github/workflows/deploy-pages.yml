# ------------------------------------------------------------------------------
# GitHub Actions scripts 
# Copyright(c) pgRouting Contributors
#
# Main configuration
# ------------------------------------------------------------------------------
name: Deploy GitHub Pages

on:
  push:
    branches:
      - master
      - testtransifex

jobs:
  deploy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Install apt packages
        run: |
          sudo apt-get install cmake cpanminus
          sudo cpanm Text::SimpleTable::AutoWidth

      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.6'
          architecture: 'x64'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r ./requirements.txt

      # This section updates the gh-pages
      - name: Build pages
        run: |
          mkdir -p build
          pushd build > /dev/null || exit 1
          cmake -DHTML=ON -DFI=ON -DIT=ON -DJA=ON -DES=ON -DFR=ON -DDE=ON -DHU=ON -DOSGeoLiveDoc_DEBUG=ON -DLOCALE=ON ..
          make
          popd
          bash scripts/clean-images.sh
          # needed for gh pages to keep dirs starting with _
          touch build/doc/_build/html/.nojekyll 
          du -h build/doc/_build/html

      # This section updates the locale
      - name: Extract commit hash
        if: github.ref == 'refs/heads/testtransifex'
        run: |
          git_hash=$(git rev-parse --short "$GITHUB_SHA")
          echo "GIT_HASH=$git_hash" >> $GITHUB_ENV

      - name: Initialize mandatory git config                                                                           
        if: github.ref == 'refs/heads/testtransifex'
        run: |                                                                                                          
          git config user.name "github-actions[bot]"                                                                    
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"                                 
                                                                                                                        
      - name: Update locale                                                                                             
        if: github.ref == 'refs/heads/testtransifex'
        run: |                                                                                                          
          # List all the files that need to be committed in build/docs/locale_changes.txt                              
          awk '/^Update|^Create/{print $2}' build/docs/locale_changes.txt > tmp && mv tmp build/docs/locale_changes.txt        # .po files
          cat build/docs/locale_changes.txt | perl -pe 's/(.*)en\/LC_MESSAGES(.*)/$1pot$2t/' >> build/docs/locale_changes.txt  # .pot files
          cat build/docs/locale_changes.txt                                                                             
                                                                                                                        
          # Remove obsolete entries #~ from .po files                                                                   
          tools/transifex/remove_obsolete_entries.sh                                                                    
                                                                                                                        
          # Add the files, commit and push                                                                              
          for line in `cat build/docs/locale_changes.txt`; do git add "$line"; done                                     
          git diff --staged --quiet || git commit -m "Update locale: commit ${{ env.GIT_HASH }}"                        
          git fetch origin testtransifex                                                                                      
          git restore .  # Remove the unstaged changes before rebasing                                                  
          git rebase origin/testtransifex                                                                                     
          git push origin testtransifex      


      - name: Deploy pages
        if: github.ref == 'refs/heads/master'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/doc/_build/html/
